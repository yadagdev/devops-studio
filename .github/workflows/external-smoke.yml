name: external-smoke

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *" # daily 03:17 UTC (= JST 12:17) くらい

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      TARGET_HOST: ops.yadag.fyi

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd

      - name: HTTPS health checks
        run: |
          set -euo pipefail
          curl -fsS "https://${TARGET_HOST}/healthz" >/dev/null
          curl -fsS "https://${TARGET_HOST}/_internal/healthz" >/dev/null
          curl -fsS "https://${TARGET_HOST}/_internal/upstream/delay-api" >/dev/null

      - name: deny_sensitive regression checks
        run: |
          set -euo pipefail
          code_env="$(curl -s -o /dev/null -w '%{http_code}' "https://${TARGET_HOST}/.env")"
          code_git="$(curl -s -o /dev/null -w '%{http_code}' "https://${TARGET_HOST}/.git/config")"
          test "$code_env" = "404"
          test "$code_git" = "404"

      - name: HSTS header check (basic)
        run: |
          set -euo pipefail
          curl -sSI "https://${TARGET_HOST}/healthz" | tr -d '\r' | grep -i '^strict-transport-security:' >/dev/null

      - name: SSH port must be CLOSED
        run: |
          set -euo pipefail
          if nc -vz -w 3 "${TARGET_HOST}" 22; then
            echo "ERROR: port 22 seems OPEN from internet"
            exit 1
          fi
          echo "OK: port 22 is not reachable"

      - name: Check security headers
        run: |
          set -euo pipefail
          URL="https://${TARGET_HOST}/healthz"

          headers="$(curl -sSI "$URL" | tr -d '\r')"
          echo "$headers"
          
          echo "$headers" | grep -i '^strict-transport-security:' >/dev/null
          echo "$headers" | grep -i '^x-content-type-options:\s*nosniff' >/dev/null
          echo "$headers" | grep -i '^x-frame-options:' >/dev/null
          echo "$headers" | grep -i '^referrer-policy:' >/dev/null

          echo "OK: required security headers present"