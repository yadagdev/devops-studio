name: Deploy to Chronos
on:
  workflow_dispatch: # 手動デプロイ用
  push:
    branches:
      - main # main にpushされたら自動デプロイ
jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Checkout devops-studio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load last successful commit SHA
        shell: bash
        run: |
          set -euo pipefail
          STATE_DIR="/home/chronos/workspace/_state/devops-studio"
          SUCCESS_FILE="${STATE_DIR}/last_success_sha"
          mkdir -p "${STATE_DIR}"

          if [ -f "${SUCCESS_FILE}" ]; then
            echo "PREV_SUCCESS_SHA=$(cat "${SUCCESS_FILE}")" >> "$GITHUB_ENV"
            echo "Loaded previous successful SHA: $(cat "${SUCCESS_FILE}")"
          else
            echo "PREV_SUCCESS_SHA=" >> "$GITHUB_ENV"
            echo "No previous successful SHA file yet."
          fi

      - name: Show runner info
        run: |
          echo "Runner hostname:"
          hostname
          echo "Current directory:"
          pwd

      - name: Deploy proxy
        run: |
          cd docker/proxy
          docker compose -f docker-compose.proxy.yaml up -d

      - name: Apply nginx config (test + reload)
        shell: bash
        run: |
          set -euo pipefail
          cd docker/proxy
          docker compose -f docker-compose.proxy.yaml exec -T devops-proxy nginx -t
          docker compose -f docker-compose.proxy.yaml exec -T devops-proxy nginx -s reload
      - name: Healthcheck (proxy + delay-api)
        shell: bash
        run: |
          set -euo pipefail
          base="http://localhost:8081"
          CHECK_PATHS=(
            "/healthz"
            "/delay-api/healthz"
          )

          echo "Healthcheck targets:"
          printf ' - %s\n' "${CHECK_PATHS[@]}"

          for i in {1..30}; do
            ok=1
            for p in "${CHECK_PATHS[@]}"; do
              if ! curl -fsS "${base}${p}" >/dev/null; then
                ok=0
                break
              fi
            done

            if [ "$ok" -eq 1 ]; then
              echo "Healthcheck OK"
              exit 0
            fi

            echo "Healthcheck retry ${i}/30 ..."
            sleep 2
          done
          echo "Healthcheck FAILED"
          echo "--- docker compose ps ---"
          docker compose -f docker/proxy/docker-compose.proxy.yaml ps || true
          echo "--- docker compose logs (proxy) ---"
          docker compose -f docker/proxy/docker-compose.proxy.yaml logs --tail=200 devops-proxy || true
          echo "--- docker compose logs (delay-api) ---"
          docker compose -f /home/chronos/workspace/apps/delay-api/docker-compose.yaml logs --tail=200 delay-api || true
          exit 1

      - name: Save successful commit SHA
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          STATE_DIR="/home/chronos/workspace/_state/devops-studio"
          SUCCESS_FILE="${STATE_DIR}/last_success_sha"
          echo "${GITHUB_SHA}" > "${SUCCESS_FILE}"
          echo "Saved successful SHA: ${GITHUB_SHA}"

      - name: Rollback to last successful commit
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${PREV_SUCCESS_SHA}" ]; then
            echo "No PREV_SUCCESS_SHA available. Cannot rollback."
            exit 1
          fi

          echo "Rolling back to ${PREV_SUCCESS_SHA}"
          git fetch --all --prune
          git checkout --force "${PREV_SUCCESS_SHA}"

          cd docker/proxy
          docker compose -f docker-compose.proxy.yaml up -d

          base="http://localhost:8081"
          for i in {1..30}; do
            if curl -fsS "${base}/healthz" >/dev/null && curl -fsS "${base}/delay-api/healthz" >/dev/null; then
              echo "Rollback healthcheck OK"
              exit 0
            fi
            echo "Rollback healthcheck retry ${i}/30 ..."
            sleep 2
          done

          echo "Rollback FAILED"
          docker compose -f docker-compose.proxy.yaml ps || true
          docker compose -f docker-compose.proxy.yaml logs --tail=200 devops-proxy || true
          exit 1