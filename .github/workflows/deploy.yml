name: Deploy to Chronos
on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: deploy-devops-studio
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 30

    steps:
      - name: Checkout devops-studio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: repo

      - name: Load last successful commit SHA
        shell: bash
        run: |
          set -euo pipefail
          STATE_DIR="/home/chronos/workspace/_state/devops-studio"
          SUCCESS_FILE="${STATE_DIR}/last_success_sha"
          mkdir -p "${STATE_DIR}"
          if [ -f "${SUCCESS_FILE}" ]; then
            echo "PREV_SUCCESS_SHA=$(cat "${SUCCESS_FILE}")" >> "$GITHUB_ENV"
          else
            echo "PREV_SUCCESS_SHA=" >> "$GITHUB_ENV"
          fi

      - name: Sync repo to app dir (fixed)
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="/home/chronos/workspace/apps/devops-studio"
          mkdir -p "${APP_DIR}"
          rsync -a --delete repo/ "${APP_DIR}/"

      - name: Deploy proxy (fixed dir)
        shell: bash
        run: |
          set -euo pipefail
          cd /home/chronos/workspace/apps/devops-studio/docker/proxy
          docker compose -p devops-studio-proxy -f docker-compose.proxy.yaml up -d
          docker compose -p devops-studio-proxy -f docker-compose.proxy.yaml exec -T devops-proxy nginx -t
          docker compose -p devops-studio-proxy -f docker-compose.proxy.yaml exec -T devops-proxy nginx -s reload

      - name: Healthcheck (proxy + delay-api)
        shell: bash
        run: |
          set -euo pipefail
          base="http://localhost:80"
          for i in {1..30}; do
            if curl -fsS "${base}/healthz" >/dev/null && curl -fsS "${base}/delay-api/healthz" >/dev/null; then
              echo "Healthcheck OK"
              exit 0
            fi
            sleep 2
          done

          echo "Healthcheck FAILED"
          docker compose -p devops-studio-proxy -f /home/chronos/workspace/apps/devops-studio/docker/proxy/docker-compose.proxy.yaml ps || true
          docker compose -p devops-studio-proxy -f /home/chronos/workspace/apps/devops-studio/docker/proxy/docker-compose.proxy.yaml logs --tail=200 devops-proxy || true
          exit 1

      - name: Save successful commit SHA
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          STATE_DIR="/home/chronos/workspace/_state/devops-studio"
          SUCCESS_FILE="${STATE_DIR}/last_success_sha"
          echo "${GITHUB_SHA}" > "${SUCCESS_FILE}"

      - name: Rollback to last successful commit
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${PREV_SUCCESS_SHA}" ]; then
            echo "No PREV_SUCCESS_SHA available. Cannot rollback."
            exit 1
          fi

          echo "Rolling back to ${PREV_SUCCESS_SHA}"
          cd repo
          git checkout --force "${PREV_SUCCESS_SHA}"

          APP_DIR="/home/chronos/workspace/apps/devops-studio"
          rsync -a --delete ../repo/ "${APP_DIR}/"

          cd /home/chronos/workspace/apps/devops-studio/docker/proxy
          docker compose -p devops-studio-proxy -f docker-compose.proxy.yaml up -d
          docker compose -p devops-studio-proxy -f docker-compose.proxy.yaml exec -T devops-proxy nginx -t
          docker compose -p devops-studio-proxy -f docker-compose.proxy.yaml exec -T devops-proxy nginx -s reload
