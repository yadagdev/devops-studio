# rate limit zones (http context)
include /etc/nginx/snippets/ratelimit.conf;

# ==============================
# HTTP :80 (ACMEのみ許可 / 他はHTTPS)
# ==============================
server {
  listen 80;
  server_name yadag-studio.duckdns.org;

  # Let's Encrypt HTTP-01 (webroot)
  location ^~ /.well-known/acme-challenge/ {
    # certbot がホスト側に作るファイルを、nginx が読める場所にする
    root /var/www/letsencrypt;
    try_files $uri =404;
    default_type text/plain;

    # 認証は絶対にかけない（更新のため）
    auth_basic off;
  }

  # 他は全部 HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

# ==============================
# HTTPS :443
# ==============================
server {
  listen 443 ssl;
  server_name yadag-studio.duckdns.org;

  # ------------------------------
  # Security headers (baseline)
  # ------------------------------
  add_header X-Frame-Options "DENY" always;
  
  ssl_certificate     /etc/letsencrypt/live/yadag-studio.duckdns.org/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yadag-studio.duckdns.org/privkey.pem;

  # ------------------------------
  # 全体 Basic認証（例外あり）
  # ------------------------------
  auth_basic           "Restricted";
  auth_basic_user_file /etc/nginx/.htpasswd;

  # ACMEは認証OFF（将来 webroot 更新をするため）
  location ^~ /.well-known/acme-challenge/ {
    auth_basic off;
    root /var/www/letsencrypt;
    try_files $uri =404;
    default_type text/plain;
  }

  # 監視を外部から叩くなら、healthz は認証OFFが楽
  # (もし認証ONにしたければ、monitor側で Authorization ヘッダを付ける)
  location = /healthz {
    auth_basic off;

    # rate limit
    include /etc/nginx/snippets/ratelimit_health.conf;
    
    default_type text/plain;
    return 200 "ok\n";
  }

  # protect all internal endpoints by default
  location ^~ /_internal/ {
    auth_basic           "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
  }

  # deny設定
  include /etc/nginx/snippets/deny_sensitive.conf;

  # 監視専用
  include /etc/nginx/conf.d/includes/10_internal_health.conf;

  # TLS最小設定
  include /etc/nginx/snippets/tls_min.conf;

  # 通常ルーティング
  include /etc/nginx/conf.d/apps/*.conf;


  # ルート（動作確認用）
  location / {
    default_type text/plain;
    return 200 "devops-proxy ok\n";
  }
}
